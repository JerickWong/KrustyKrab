<html lang="en"><head>
    <link rel="stylesheet" href="SD-custserv.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <title>Krusty Krab</title>
</head>
<body>
    <div id="main">
        <nav>
            <p id="krustykrab">
                <img class="logo" src="assets/log-head.png" alt="krustykrablogo"> <span id="name">Krusty Krab</span> 
            </p>
            <ul>
                <li><a href="homepage.html">HOME</a></li>
                <li><a href="profile.html">PROFILE</a></li>
                <li><a href="#">SALES DATA</a>
                    <ul>
                        <li><a href="customerserved.html">Customers Served</a></li>
                        <li><a href="grubpopularity.html">Grub Popularity</a></li>
                        <li><a href="perspecies.html">Grub Preference per Species</a></li>
                    </ul>
                </li>
                <li><a href="about.html">ABOUT MR. KRABS</a></li>
                <li><a href="upload.html">UPLOAD DATA</a></li>
            </ul>
            <a href="index.html"><button type="button" id="btn-logout"><img src="assets/logout.png" id="img-logout">&nbsp;Log Out</button></a>
        </nav>
        
        <div id="container">
            <div class="sortby">Search by Date: <input type="date" id="date"></div>
            
            <div class="chartcontainer">
                <canvas class="charts" id="bar"></canvas>            
            </div>

            <div class="chartcontainer">
                <canvas class="charts" id="line"></canvas>            
            </div>
            
        </div>

        <script>
            // if user has not logged in yet, redirect to login page
            if (window.localStorage.getItem("logged")==null) {
                location.href = "index.html"
            }
            // logging out
            document.getElementById("btn-logout").addEventListener("click", function(){
                let logged = window.localStorage.removeItem("logged")            
                location.href = "index.html"
            })

            let data = localStorage.getItem("json")
            let datetime = localStorage.getItem("datetime")
            let dataObject = JSON.parse(data)
            let datetimeObject = JSON.parse(datetime)

            // fix data to charts according to date
            function fix_data(chart, loaded, datetime, date) {
                var i
                console.log(date)
                console.log(loaded.customerSpecies)
                chart.time = []
                chart.number_of_customers = []
                for (i=0; i<loaded.customerSpecies.length; i++) {                    
                    if (loaded.timestamp[i].includes(date)) {
                        console.log("same date?")
                        if (chart.time.includes(datetime.time[i]))
                            chart.number_of_customers[chart.time.indexOf(datetime.time[i])]++;
                        else {
                            
                            chart.time.push(datetime.time[i])
                            chart.number_of_customers.push(1)
                            console.log("chart number of orders: " + chart.number_of_customers)
                        }                                            
                    }
                }
                show_data()
            }            

            // fixing format to timestamp's date format
            function fix_format(format) {
                    if (format<10) {
                        var string = format.toString()
                        string = '0' + string
                    }
                        return string
                }

            // gets today's date and their proper format
            var today = new Date()
            var mm = today.getMonth()+1
            var dd = today.getDate()
            mm = fix_format(mm)
            dd = fix_format(dd) 

            let customerservedData = {
                "time" : [],
                "number_of_customers" : []
            }

            let CSBar = document.getElementById('bar').getContext('2d');
            let CSLine = document.getElementById('line').getContext('2d');            

            Chart.defaults.global.defaultFontSize = 12;
            Chart.defaults.global.defaultFontColor = '#777';
            
            // initial data, current date
            fix_data(customerservedData, dataObject, datetimeObject, today.getFullYear()+'-'+mm+'-'+dd)

            function show_data() {
                let CS_Bar = new Chart(CSBar, {
                    type: 'bar',
                    data: {
                        labels: customerservedData.time,
                        datasets: [{
                            label: 'Number of Customers',
                            data: customerservedData.number_of_customers
                        }],
                    },
                    options: {
                        title:{
                            display: true,
                            text: 'Customers Served',
                            fontSize: 16
                        }
                    }
                });

                let CS_Line = new Chart(CSLine, {
                    type: 'line',
                    data: {
                        labels: customerservedData.time,
                        datasets: [{
                            label: 'Number of Customers',
                            data:customerservedData.number_of_customers
                        }],
                    },
                    options: {
                        title:{
                            display: true,
                            text: 'Customers Served',
                            fontSize: 16
                        }
                    }
                });
            }
            
            // search data by date
            document.getElementById("date").onchange = function() {
                console.log("ginalaw mo ko!")
                var searchDate = document.getElementById("date").value
                var i
                for (i=0; i<datetimeObject.date.length; i++) {
                    if (searchDate == datetimeObject.date[i]) {
                        fix_data(customerservedData, dataObject, datetimeObject, searchDate)
                    }                            
                }
            }
        </script>

    
    </div>
    

</body></html>